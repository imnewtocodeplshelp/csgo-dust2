<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Outrun the Cops</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body { margin: 0; overflow: hidden; touch-action: none; }
canvas { display: block; }
#ui {
  position: absolute;
  top: 10px;
  left: 10px;
  font-family: Arial;
  color: white;
  background: rgba(0,0,0,0.5);
  padding: 6px;
  border-radius: 6px;
}
#gameOver {
  position: absolute;
  inset: 0;
  display: none;
  background: rgba(0,0,0,0.7);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  font-family: Arial;
  font-size: 32px;
}
#gameOver button {
  padding: 10px 20px;
  font-size: 24px;
  margin-top: 20px;
  cursor: pointer;
}
#leaderboard {
  margin-top: 20px;
  font-size: 20px;
}
</style>
</head>
<body>
<p><canvas id="game"></canvas></p>
<div id="ui">Cops: <span id="copCount">0</span><br />Score: <span id="score">0</span></div>
<div id="gameOver">Game Over
<div>Your Score: <span id="finalScore">0</span></div>
<div id="leaderboard"></div>
<button id="restartBtn">Restart</button></div>
<p>
<script>
let canvas = document.getElementById("game");
let ctx = canvas.getContext("2d");
let copCount = document.getElementById("copCount");
let scoreSpan = document.getElementById("score");
let gameOverDiv = document.getElementById("gameOver");
let restartBtn = document.getElementById("restartBtn");
let finalScoreSpan = document.getElementById("finalScore");
let leaderboardDiv = document.getElementById("leaderboard");
let bgColor = "#89c3e0";

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
resize();
window.addEventListener("resize", resize);

// INPUT
let left=false, right=false;
window.addEventListener("touchstart", e => { e.touches[0].clientX < window.innerWidth/2 ? left=true : right=true; });
window.addEventListener("touchend", ()=> left=right=false);
window.addEventListener("keydown", e=>{ if(e.key==="ArrowLeft"||e.key==="a") left=true; if(e.key==="ArrowRight"||e.key==="d") right=true; });
window.addEventListener("keyup", ()=> left=right=false);

// GAME STATE
let running=true, spawnTimer=0;
let score=0;
let player={ x:0, y:0, angle:-Math.PI/2, speed:4, alive:true };
let cops=[], tireMarks=[];
const MAX_MARKS=1200;
let explosions=[];

// SPAWN COP
function spawnCop() {
  let a=Math.random()*Math.PI*2;
  cops.push({ x:player.x+Math.cos(a)*700, y:player.y+Math.sin(a)*700, angle:a+Math.PI, speed:2.4, turn:0.04 });
}

// LOGIC
function updatePlayer(){
  if(!player.alive) return;
  if(left) player.angle-=0.05;
  if(right) player.angle+=0.05;
  player.x+=Math.cos(player.angle)*player.speed;
  player.y+=Math.sin(player.angle)*player.speed;

  tireMarks.push({ x:player.x, y:player.y });
  if(tireMarks.length>MAX_MARKS) tireMarks.shift();
}

function updateCops(){
  for(let c of cops){
    let t=Math.atan2(player.y-c.y, player.x-c.x);
    let d=Math.atan2(Math.sin(t-c.angle), Math.cos(t-c.angle));
    c.angle += d*c.turn;
    c.x += Math.cos(c.angle)*c.speed;
    c.y += Math.sin(c.angle)*c.speed;
    tireMarks.push({ x:c.x, y:c.y });
    if(tireMarks.length>MAX_MARKS) tireMarks.shift();
  }

  if(player.alive){
    for(let c of cops){
      if(Math.hypot(player.x-c.x, player.y-c.y)<22){
        createExplosion(player.x,player.y);
        player.alive=false;
        showGameOver();
        break;
      }
    }
  }

  for(let i=cops.length-1; i>=0; i--){
    for(let j=i-1; j>=0; j--){
      let c1=cops[i], c2=cops[j];
      if(Math.hypot(c1.x-c2.x,c1.y-c2.y)<22){
        createExplosion((c1.x+c2.x)/2, (c1.y+c2.y)/2);
        cops.splice(i,1);
        score += 50;
        break;
      }
    }
  }
}

function createExplosion(x,y){
  let ex={x,y,particles:[],timer:0};
  for(let i=0;i<30;i++){ ex.particles.push({x,y,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*6,life:1}); }
  explosions.push(ex);
}

function updateExplosions(){
  for(let ex of explosions){
    ex.timer += 1/60;
    for(let p of ex.particles){ p.x += p.vx; p.y += p.vy; p.life -= 0.03; }
  }
}

// DRAW
function drawCar(x,y,a,color){
  ctx.save();
  ctx.translate(x,y);
  ctx.rotate(a);
  ctx.fillStyle=color;
  ctx.fillRect(-15,-8,30,16);
  ctx.restore();
}

function drawExplosions(){
  for(let ex of explosions){
    for(let p of ex.particles){ if(p.life>0){ ctx.fillStyle=`rgba(255,100,0,${p.life})`; ctx.fillRect(p.x,p.y,3,3); } }
  }
}

function draw(){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.fillStyle=bgColor;
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.translate(canvas.width/2 - player.x, canvas.height/2 - player.y);

  ctx.strokeStyle="rgba(20,20,20,0.95)";
  ctx.lineWidth=3;
  ctx.beginPath();
  for(let m of tireMarks){ ctx.moveTo(m.x,m.y); ctx.lineTo(m.x+0.1,m.y+0.1); }
  ctx.stroke();

  if(player.alive) drawCar(player.x,player.y,player.angle,"lime");
  for(let c of cops) drawCar(c.x,c.y,c.angle,"red");
  drawExplosions();
}

// AUTO SCORE
let autoScore = setInterval(()=>{ if(running) score += 1; },1000);

// GAME OVER
function showGameOver(){
  running=false;
  finalScoreSpan.textContent = score;

  let nickname = prompt("Enter your nickname:", "Player");
  if(!nickname) nickname="Player";

  fetch("leaderboard.php", {
    method: "POST",
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: "action=submit&nickname=" + encodeURIComponent(nickname) + "&score=" + score
  })
  .then(res => res.json())
  .then(data => {
    leaderboardDiv.innerHTML = "<b>Leaderboard:</b><br>" + data.map(e=>`${e.nickname}: ${e.score}`).join("<br>");
  })
  .catch(err => console.error(err));

  gameOverDiv.style.display = "flex";
}

// RESTART
restartBtn.addEventListener("click", ()=>{
  player={ x:0, y:0, angle:-Math.PI/2, speed:4, alive:true };
  cops=[]; tireMarks=[]; explosions=[]; spawnTimer=0; score=0;
  running=true; gameOverDiv.style.display="none";
  loop();
});

// LOOP
function loop(){
  if(!running) return;
  updatePlayer(); updateCops(); updateExplosions();
  spawnTimer++;
  if(spawnTimer>180){ spawnCop(); spawnTimer=0; }
  draw();
  copCount.textContent = cops.length;
  scoreSpan.textContent = score;
  requestAnimationFrame(loop);
}

// START
setTimeout(spawnCop,1000);
loop();
</script>
</p>
</body>
</html>